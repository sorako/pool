<!DOCTYPE html>
<html lang="en">
<head>
  <title>test Example</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>

  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>  
  

</head>
<body>

<div class="jumbotron text-center">
  
</div>
<div class="container">
  <div class="row" style="margin-bottom: 50px;">
    <div class="col-sm-4">
    
    </div>
    <div class="col-sm-4">
      <select class="action form-control" id="categoryEvent" onchange="myFunction(value)">
      </select>
    </div>
    <div class="col-sm-4">
     
    </div>
  </div>
</div>  
<div class="container">
  <div class="row">
    <div class="col-sm-8">
       <h1><p id="demo"></p></h1> 
    </div>
    <div class="col-sm-3">
      <h1><p id="symbol"></p></h1> 
    </div>
    <div class="col-sm-3">
      
    </div>
    <div class="col-sm-3">
      
    </div>
  </div>

  <div class="row">
    <div class="col-sm-3">
      <div class="card" style="border-color: #337ab7; width:200px; height:150px; color: white;">
        <h3 style="background-color: #337ab7;width: 100%;height: 100px;"> <p id="same" style="text-align: center; margin-top: 35px;"></p></h3>
        <div class="card-body"style="background-color: #f1f1f1;;color: black;text-align: center;"id="priceChange"></div>
      </div>
    </div>
    <div class="col-sm-3">
      <div class="card" style="border-color: #ffbd2e; width:200px; height:150px; color: #8b6e3c;">
        <h4 style="background-color: #ffbd2e;width: 100%;height: 100px;"> <p id="same" style="text-align: center; margin-top: 35px;"></p></h4>
        <div class="card-body"style="background-color: #f1f1f1;color: black;text-align: center;" >時価総額</div>
      </div>
    </div>
    <div class="col-sm-3">
      <div class="card" style="border-color: #dcbcbc; width: 200px; height:150px;color: #a75858;">
        <h4 style="background-color: #dcbcbc;width: 100%;height: 100px;"> <p id="percentChange" style="text-align: center; margin-top: 35px;"></p></h4>
        <div class="card-body"style="background-color: #f1f1f1;color: black;text-align: center;">ROA</div>
      </div>
      <p id="demo"></p>
    </div>
    <div class="col-sm-3">
      <div class="card" style="border-color: #dcbcbc; width: 200px;height:150px;color: #a75858;">
        <h4 style="background-color: #dcbcbc;width: 100%;height: 100px;"> <p id="percentChange1" style="text-align: center; margin-top: 35px;"></p></h4>
        <div class="card-body"style="background-color: #f1f1f1;color: black;text-align: center;">ROE</div>
      </div>
      <p id="demo"></p>
    </div>
  </div>
</div>
<div class="container">
  <div class="row">
    <div class="col-sm-6">
      <canvas id="barsChart" width="200" height="200" ></canvas>
    </div>
    
    <div class="col-sm-6">
      <canvas id="line-chart" width="200" height="200"></canvas>
    </div>  
  </div> 
  <div class="row">
    <div class="col-sm-6">
      <canvas id="barChart" width="200" height="200" ></canvas>
    </div>
    
    <div class="col-sm-6">
      <canvas id="line-chart" width="200" height="200"></canvas>
    </div>  
  </div>  
</div>
<script type="text/javascript">
  var url = "http://localhost:5000/api";
  var ur1 = "http://localhost:5000/api_pl";
  var ur2 = "http://localhost:5000/api_bs";
  var ur3 = "http://localhost:5000/api_cf";
  var id = 0
  var xhr;
  
  if (window.XMLHttpRequest) {
      xhr = new XMLHttpRequest();
  } else {
      xhr = new ActiveXObject("Microsoft.XMLHTTP");
  }
  xhr.onreadystatechange = function () {
    if (xhr.readyState == 4 && xhr.status == 200) {
      var res = JSON.parse(xhr.responseText),
        data = res.data;
      for(var i = 0; i < data.length; i++) {
        var ele = document.createElement("option");
        ele.value = data[i].id;
        $(".action").append("<option>"+ele.value+"</option>"); 
      }
    }
  }
  xhr.open("GET", url, true);
  xhr.send();

  
  //id avaj company_name uzuuleh
  function myFunction(id) {

    function na_judge(calc_list){
    // リスト内に'NA'があった場合に、０を代入することで、グラフ表示でエラーを出さなくする
    // :param calc_list: 売り上げなどのリスト
    // :return: NAの場合は0を代入したリストを返す
      for (nj = 0; nj < 5; nj++) {
        if( 'NaN' == calc_list[nj]){
           calc_list[nj] = 0
        }
      }  
       return calc_list   
    }        
   
    function non_converter(percentage_list){
    // グラフ化にあたって、前段でNAを0に戻したものをグラフに表示させないためにnonに変換する
    // :param percentage_list:
    // :return:
      for (nzr = 0; nzr < 5; nzr++){
        if (0 == percentage_list[nzr]){
          percentage_list[nzr] = 'non'
        }  
      }  
       return percentage_list  
    }     

    $.getJSON('http://localhost:5000/api/'+id+'').done(function(datas) {
      var symbol = datas.data[0].symbol
      document.getElementById("demo").innerHTML = datas.data[0].company_name;
      document.getElementById("same").innerHTML = datas.data[0].stock_price +"ドル";
      document.getElementById("priceChange").innerHTML = "前日比 :"+datas.data[0].priceChange +"ドル";
      document.getElementById("percentChange").innerHTML = datas.data[0].percentChange ;
      document.getElementById("percentChange1").innerHTML = datas.data[0].percentChange ;
      document.getElementById("symbol").innerHTML = datas.data[0].symbol.split('OTC:').join('');  
    })
    $.getJSON(ur1).done(function(datas) {
      var i = 0
      arrPeriod = []
      arrRevenue = []
      arr_Gross_sales_profit = []
      arr_Net_income = []
      for (i = 0; i < datas.data.length; i++) {
        var company_id = datas.data[i].company_id
        if(id == company_id){
          var company = datas.data[i]
          var period = company.period.toString()
          var revenue = parseInt(company.revenues)
          var sales_profit = parseInt(company.operating_income)
          var net_income = parseInt(company.net_income)
          arrPeriod.push(period)
          arrRevenue.push(revenue)
          arr_Gross_sales_profit.push(sales_profit)
          arr_Net_income.push(net_income)
        } 
      }
      var zero_Total_revenue = na_judge(arrRevenue)
      var zero_GSP = na_judge(arr_Gross_sales_profit)
      var netIncome_Value =  na_judge(arr_Net_income) 
      
      var arrayLabel = arrPeriod
      var data1 = arrRevenue
      var data2 = arr_Gross_sales_profit
      var data3 = arr_Net_income
      charts(arrayLabel,data1,data2,data3)

      var y_min = Math.min.apply(Math, zero_GSP)
      
      if (Math.min.apply(Math, zero_GSP) <= 0 ||Math.min.apply(Math, netIncome_Value)<= 0 ) {
        if(Math.min.apply(Math, zero_GSP) <= Math.min.apply(Math, netIncome_Value)){
          y_min = Math.min.apply(Math, zero_GSP)
        }else{
          y_min = Math.min.apply(Math, netIncome_Value)
        }
      }else{
        var y_max = Math.max.apply(Math, zero_GSP) 
      }
     
      total_assets = []
      adequacy_ratios = []
      roas = []
      roes = []
      $.getJSON(ur2).done(function(datas) {
        for (i = 0; i < datas.data.length; i++) {
          var company_id = datas.data[i].company_id
          if(id == company_id){
            var bs = datas.data[i]
            var total_asset = parseInt(bs.total_asset)
            total_assets.push(total_asset)
            var adequacy_ratio =  parseInt(bs.adequacy_ratio)
            adequacy_ratios.push(adequacy_ratio)
            var roa =  parseInt(bs.ROA)
            roas.push(roa)
            var roe =  parseInt(bs.ROE)
            roes.push(roe)
          }
        }
       
        var gross_sales_margin_float = [] 
        for (gs = 0; gs < 5; gs++){
           if( zero_Total_revenue[gs] == 0){
              gross_sales_margin_float.push(0);
           }else{
              gross_sales_margin_float.push(Math.round(zero_GSP[gs] / arrRevenue[gs], 3));
           }
        }
        var  roa_float = []
        console.log(total_assets)
        for (gs = 0; gs < 5; gs++){
          if(total_assets[gs] == 0){
            roa_float.push(0);
          }else{
            roa_float.push(Math.round(zero_GSP[gs] / total_assets[gs], 3));
          }
        }
        var roe_float = []
        for (gs = 0; gs < 5; gs++){
          if(adequacy_ratios[gs] == 0){   
            roe_float.push(0) 
          }else{
            roe_float.push(Math.round(netIncome_Value[gs] / adequacy_ratios[gs], 3)) 
          }
        }

        var y_min2 = Math.min.apply(Math, gross_sales_margin_float)
        console.log(y_min2)
        if(Math.min.apply(Math, gross_sales_margin_float) <= Math.min.apply(Math, roa_float) || Math.min.apply(Math, gross_sales_margin_float) <= Math.min.apply(Math, roe_float)){
          if(Math.min.apply(Math, gross_sales_margin_float) <= Math.min.apply(Math, roa_float) && Math.min.apply(Math, gross_sales_margin_float) <= Math.min.apply(Math, roe_float)){
              y_min2 = Math.min.apply(Math, gross_sales_margin_float)
          }else if( Math.min.apply(Math, roa_float)<= Math.min.apply(Math, gross_sales_margin_float)){
              y_min2 = Math.min.apply(Math, roa_float)
          }else{
               y_min2 = Math.min.apply(Math,roe_float)
          }
        } else{
          y_min2 = 0  
        }
       
        var y_max = 0.5
        if(Math.max.apply(Math, gross_sales_margin_float) >= Math.max.apply(Math, roa_float) && Math.max.apply(Math, gross_sales_margin_float) >= Math.max.apply(Math, roe_float)){
          if(Math.max.apply(Math, gross_sales_margin_float) >= 0){
            y_max = Math.max.apply(Math, gross_sales_margin_float)
          } else if( Math.max.apply(Math, roa_float) >= Math.max.apply(Math, roe_float)){
            if(Math.max.apply(Math, roa_float) <= 0){
                y_max = max(roa_float)
              }else{
                y_max = 0.5 
            }
          } else if( Math.max.apply(Math, roe_float) <= 0){
              y_max = 0.5
          }else{
            y_max = 0.5
          }
        }else{
          y_max = Math.max.apply(Math,roe_float)
        }   
        var data4 = non_converter(gross_sales_margin_float)
        var data5 = non_converter(roa_float)
        var data6 = non_converter(roe_float)
        chartLine(arrayLabel,data4,data5,data6)
      })  
      var net_OP_Cash_Flow_Value =[]
      var net_financial_CF = []
      var net_Inv_CF_Total =[]
      var fcf =[]
      // Net_Operating_Cash_Flow, Net_Investing_Cash_Flow, Net_Financing_Cash_Flow, Quarterly_free_cash_flow,
      $.getJSON(ur3).done(function(datas) {
        for (i = 0; i < datas.data.length; i++) {
          var company_id = datas.data[i].company_id
          if(id == company_id){
            var bs = datas.data[i]
            var total_asset = parseInt(bs.Net_Operating_Cash_Flow)
            net_OP_Cash_Flow_Value.push(total_asset)
            var adequacy_ratio =  parseInt(bs.Net_Financing_Cash_Flow)
            net_financial_CF.push(adequacy_ratio)
            var roa =  parseInt(bs.Net_Investing_Cash_Flow)
            net_Inv_CF_Total.push(roa)
            var roe =  parseInt(bs.Quarterly_free_cash_flow)
            fcf.push(roe)
          }
        }

        var y3_min = []
        y3_min.push(Math.min.apply(Math,net_OP_Cash_Flow_Value))
        y3_min.push(Math.min.apply(Math,net_financial_CF))
        y3_min.push(Math.min.apply(Math,net_Inv_CF_Total))
        y3_min.push(Math.min.apply(Math,fcf))
        minifig = Math.min.apply(Math,y3_min)

        var y3_max = []
        y3_max.push(Math.max.apply(Math,net_OP_Cash_Flow_Value))
        y3_max.push(Math.max.apply(Math,net_financial_CF))
        y3_max.push(Math.max.apply(Math,net_Inv_CF_Total))
        y3_max.push(Math.max.apply(Math,fcf))
        maxfig = Math.max.apply(Math,y3_max)

        var data6 = non_converter(net_OP_Cash_Flow_Value)
        var data7 =  non_converter(net_Inv_CF_Total)
        var data8 =  non_converter(net_financial_CF)
        var data9 =  non_converter(fcf)
        chart(arrayLabel,data6,data7,data8,data9)
      })  
    })  
  } 
  function charts(arrayLabel,data1,data2,data3){
    var ctx = document.getElementById("barsChart");
    var barChart = new Chart(ctx, {
        type: 'bar',
        data: {
        labels:arrayLabel ,
        datasets: [{
          backgroundColor: '#3366ff',
          label: '売上',
          data: data1
          }]
        }
    });

    function addData(chart, label, color, data) {
        chart.data.datasets.push({
          label: label,
          backgroundColor: color,
          data: data
        });
        chart.update();
    }
    addData(barChart, '営業利益', '#ff9900', data2);
    addData(barChart, '純利益', '#ff6666', data3);
  }

  function chart(arrayLabel,data1,data2,data3,data4){
    var ctx = document.getElementById("barChart");
    var barChart = new Chart(ctx, {
        type: 'bar',
        data: {
        labels:arrayLabel ,
        datasets: [{
          backgroundColor: '#3366ff',
          label: '営業CF',
          data: data1
          }]
        }
    });
  
    function addData(chart, label, color, data) {
        chart.data.datasets.push({
          label: label,
          backgroundColor: color,
          data: data
        });
        chart.update();
    }
    addData(barChart, '投資CF', '#ff9900', data2);
    addData(barChart, '財務CF', '#ff6666', data3);
     addData(barChart, 'フリーCF', '#33cc33', data4);
  }

  function chartLine(arrayLabel,data4,data5,data6){
    new Chart(document.getElementById("line-chart"), {
    type: 'line',
    data: {
      labels: arrayLabel,
      datasets: [{ 
          data: data4,
          label: "営業利益率",
          borderColor: "#F0BE2C",
          fill: false
        }, { 
          data: data5,
          label: "ROA",
          borderColor: "#4331F5",
          fill: false
        }, { 
          data: data6,
          label: "ROE",
          borderColor: "#e84d60",
          fill: false
        }
      ]
    },
    options: {
      title: {
        display: true,
        text: '収益性'
      }
    }
  });
  }
</script>
</body>
</html>

